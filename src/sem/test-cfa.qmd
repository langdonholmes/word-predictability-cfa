```{r}
library(tidySEM)
library(lavaan)
library(ggplot2)
library(tidyverse)
```

```{r}
original_df <- read.csv('../../data/clc_fce_metrics_predictability_original.csv') %>%
  mutate(across(where(is.numeric) & !any_of("doc_id"),
                ~ as.numeric(scale(.))
  ))

corrected_df = read.csv('../../data/clc_fce_metrics_predictability_corrected.csv') %>%
  mutate(across(where(is.numeric) & !any_of("doc_id"),
                ~ as.numeric(scale(.))
  ))
```

```{r}
original_df  %>%   
  select(where(is.numeric) & !any_of("doc_id")) %>% 
  cor()
```


```{r}
original_df  %>%   
  select(where(is.numeric) & !any_of("doc_id")) %>% 
  cor() %>% 
  as_tibble(rownames = 'var_a') %>% 
  pivot_longer(
    -var_a,
    names_to = "var_b", 
    values_to = "correlation"
  ) %>% 
  ggplot(aes(var_a, var_b)) +
  geom_tile(aes(fill = correlation), color = 'black') +
  # geom_text(aes(label = round(correlation, 2))) +
  theme_minimal(
    base_size = 16,
    base_family = 'Source Sans Pro'
  ) +
  labs(
    x = element_blank(),
    y = element_blank(),
    fill = 'Correlation',
    title = "Variables of the CLC-FCE",
  )
```

# =============================================================================
# MODEL 1: Word Predictability → Phraseological Sophistication
# =============================================================================

```{r}
model1 <- ' 
  # First-order factors (sub-components of Complexity)
  LexSoph =~ MTLD + token_freq + lexical_density
  SynComp =~ clauses_per_tunit + mod_per_nom + dep_per_nom
  PhraSoph =~ amod + advmod + dobj # + mean_prob
  
  # Second-order factor (Complexity)
  Complexity =~ LexSoph + SynComp + PhraSoph
  
  # Other first-order factors
  Accuracy =~ error_grammar + error_vocab + error_spelling
  Fluency =~ word_count + tunit_count + clause_count
  
  # Third-order factor (Language Proficiency)
  LangProf =~ Complexity + Accuracy + Fluency
'

# Fit the model
fit1 <- sem(model1, data = original_df)

# Check model fit
summary(fit1, fit.measures = TRUE)
```

# =============================================================================
# MODEL 2: Word Predictability → Language Proficiency (direct)
# =============================================================================

```{r}
model2 <- ' 
  # First-order factors (sub-components of Complexity)
  LexSoph =~ MTLD + token_freq + lexical_density
  SynComp =~ clauses_per_tunit + mod_per_nom + dep_per_nom
  PhraSoph =~ amod + advmod + dobj
  
  # Second-order factor (Complexity)
  Complexity =~ LexSoph + SynComp + PhraSoph + mean_prob
  
  # Other first-order factors
  Accuracy =~ error_grammar + error_vocab + error_spelling
  Fluency =~ word_count + tunit_count + clause_count
  
  # Third-order factor (Language Proficiency)
  LangProf =~ Complexity + Accuracy + Fluency
'

# Fit the model
fit2 <- sem(model2, data = original_df)

# Check model fit
summary(fit2, fit.measures = TRUE)
```

# =============================================================================
# MODEL 3: Word Predictability → Accuracy
# =============================================================================

```{r}
model3 <- ' 
  # First-order factors (sub-components of Complexity)
  LexSoph =~ MTLD + token_freq + lexical_density
  SynComp =~ clauses_per_tunit + mod_per_nom + dep_per_nom
  PhraSoph =~ amod + advmod + dobj
  
  # Second-order factor (Complexity)
  Complexity =~ LexSoph + SynComp + PhraSoph
  #Complexity =~ MTLD + token_freq + lexical_density + clauses_per_tunit + mod_per_nom + dep_per_nom + amod + advmod + dobj
  
  # Other first-order factors
  Accuracy =~ error_grammar + error_vocab + error_spelling + mean_prob
  Fluency =~ word_count + tunit_count + clause_count
  
  # Third-order factor (Language Proficiency)
  LangProf =~ Complexity + Accuracy + Fluency
'

# Fit the model
fit3 <- sem(model3, data = original_df)

# Check model fit
summary(fit3, fit.measures = TRUE)
```